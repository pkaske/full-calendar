<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../iron-icon/iron-icon.html">

<dom-module id="pop-over">
  <template>
    <style>
      :host {
        display: inline-block;
        position: relative;
        outline: 0;
      }

      .toggle {
        cursor: pointer;

        @apply(--pop-over-toggle);
      }

      #content {
        position: absolute;
        left: 0;
        margin-top: var(--pop-over-spacing, 24px);
        z-index: 1;
        display: inline-block;
        transition: transform 0s, opacity 0s;
        transform: scale(0.90);
        will-change: transform, opacity;
        opacity: 0;
      }

      #content[open] {
        transition: transform 80ms, opacity 180ms;
        transform: scale(1);
        opacity: 1;
        border-radius: 2px;
        background: var(--bg-50);
        @apply(--shadow-elevation-2dp);
      }

      #content .content-wrap {
        @apply(--pop-over-content);
      }

      #content[open] {
        @apply(--pop-over-content-open);
      }

      .top-arrow {
        position: absolute;
        top: -20px;
        left: 0;
        width: 100%;

        @apply(--pop-over-icon);
        --iron-icon-width: var(--pop-over-icon-size, 32px);
        --iron-icon-height: var(--pop-over-icon-size, 32px);
      }
    </style>

    <div class="wrap">
      <div class="toggle">
        <content id="toggleContent" select="[toggle]"></content>
      </div>
      <div id="content" open$="[[isOpen]]">
        <iron-icon class="top-arrow" icon="[[topArrow]]"></iron-icon>
        <div class="content-wrap">
          <content select="[content]"></content>
        </div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pop-over',

      properties: {
        /**
         * Indicates if the pop-over is currently open.
         */
        isOpen: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        /**
         * Every click inside the popup content closes the pop-over if true.
         */
        alwaysToggle: {
          type: Boolean,
          value: false
        },

        /**
         * Icon that can be used to show a arrow at the top of the popup content.
         */
        topArrow: {
          type: String
        },

        _onDocClickHandler: {
          type: Object,
          value: function() {
            return this.close.bind(this);
          }
        }
      },

      get toggleEl() {
        if (!this._toggleEl) {
          this._toggleEl = this.getContentChildren('#toggleContent')[0];
        }
        return this._toggleEl;
      },

      hostAttributes: {
        'tabindex': '0'
      },

      listeners: {
        'click': '_onClick',
        'keydown': '_onKeyDown'
      },

      detached: function() {
        document.removeEventListener('click', this._onDocClickHandler, true);
      },

      close: function() {
        if (this.isOpen) {
          this._closeJob = this.async(function() {
            this._setIsOpen(false);
            document.removeEventListener('click', this._onDocClickHandler, true);
          }, 50);
        }
      },

      open: function() {
        this._setIsOpen(true);
        var contentWidth = this.$.content.offsetWidth;
        var toggleWidth = this.toggleEl.offsetWidth;
        this.$.content.style.marginLeft = (-1 * ((contentWidth / 2) - toggleWidth / 2)) + 'px';
        document.addEventListener('click', this._onDocClickHandler, true);
      },

      toggle: function() {
        if (!this.isOpen) {
          this.open();
        } else {
          this._setIsOpen(false);
          document.removeEventListener('click', this._onDocClickHandler, true);
        }
      },

      _onClick: function(e) {
        e.preventDefault();
        var t = Polymer.dom(e).rootTarget;
        var isToggle = this._closest(t, '[toggle]');
        if (!isToggle && !this.alwaysToggle && this._closest(Polymer.dom(e).rootTarget, '[close-pop-over]') === undefined) {
          // We didn't click a item, so cancel the global close trigger.
          this.cancelAsync(this._closeJob);
          return;
        }

        this.toggle();
      },

      _onKeyDown: function(e) {
        e = Polymer.dom(e);
        switch(e.event.keyCode) {
          case 13:
            this.toggle();
            break;
        }
      },

      _closest: function(node, selector) {
        var matches = node.matches || node.msMatchesSelector || node.oMatchesSelector;

        while (node) {
          if (matches.call(node, selector)) {
            return node;
          }
          node = node.parentElement;
        }
      },
    });
  </script>
</dom-module>
